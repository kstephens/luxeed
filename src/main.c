
/*
sudo apt-get install libusb-dev
*/

#include <stdio.h>
#include <stdlib.h> /* memset(), memcpy() */
#include <string.h>
#include "luxeed.h"


static int luxeed_dev_id = 0;

static int usb_debug_level = 9;


#if 1
#define RCALL(X) do { result = X; fprintf(stderr, "  %s => %d\n", #X, (int) result); } while ( 0 )
#else
#define RCALL(X) result = X
#endif


luxeed_device *luxeed_find_device(uint16_t vendor, uint16_t product)
{
  struct usb_bus *bus;
  struct usb_device *dev;
  struct usb_bus *busses;

  if ( ! vendor ) {
    vendor  = LUXEED_USB_VENDOR;
  }
  if ( ! product ) {
    product = LUXEED_USB_PRODUCT;
  }

  usb_init();
  usb_find_busses();
  usb_find_devices();
  busses = usb_get_busses();

  usb_set_debug(usb_debug_level);
  
  for ( bus = busses; bus; bus = bus->next ) {
    for ( dev = bus->devices; dev; dev = dev->next ) {
      if ( (dev->descriptor.idVendor == vendor) && (dev->descriptor.idProduct == product) ) {
	luxeed_device *luxeed = malloc(sizeof(*luxeed));

	memset(luxeed, 0, sizeof(*luxeed));
	luxeed->id = luxeed_dev_id ++;
	luxeed->u_bus = bus;
	luxeed->u_dev = dev;

	fprintf(stderr, "  bus %s 0x%x\n", (char*) bus->dirname, (int) bus->location);
	fprintf(stderr, "  dev %s 0x%x\n", (char*) dev->filename, (int) dev->devnum);

        return luxeed;
      }
    }
  }

  return NULL;
}


int luxeed_open(luxeed_device *dev)
{
  int result = -1;

  if ( dev->u_dh ) {
    return 0;
  }

  do {
    dev->u_dh = usb_open(dev->u_dev);
    if ( ! dev->u_dh ) {
      return -1;
    }
    
    RCALL(usb_reset(dev->u_dh));
    // RCALL(usb_resetep(dev->u_dh, LUXEED_USB_ENDPOINT_DATA));
    
    // RCALL(usb_detach_kernel_driver_np(dev->u_dh, LUXEED_USB_INTERFACE));
    // RCALL(usb_detach_kernel_driver_np(dev->u_dh, 0));
    RCALL(usb_detach_kernel_driver_np(dev->u_dh, 1));
    RCALL(usb_detach_kernel_driver_np(dev->u_dh, 2));
    
    // RCALL(usb_claim_interface(dev->u_dh, LUXEED_USB_INTERFACE));
    // RCALL(usb_claim_interface(dev->u_dh, 0));
    RCALL(usb_claim_interface(dev->u_dh, 1));
    RCALL(usb_claim_interface(dev->u_dh, 2));
    usleep(100000);

    RCALL(luxeed_init(dev));

    result = 0;

  } while ( 0 );

  return result;
}


int luxeed_close(luxeed_device *dev)
{
  int result = 0;

  do {
    if ( dev->u_dh ) {
      RCALL(usb_release_interface(dev->u_dh, 1));
      RCALL(usb_release_interface(dev->u_dh, 2));

      RCALL(usb_close(dev->u_dh));
      if ( result ) break;

      dev->u_dh = 0;
    }
  } while ( 0 );

  return result;
}


int luxeed_send(luxeed_device *dev, int ep, unsigned char *bytes, int size)
{
  int result = -1;
  int timeout = 1000;

  usb_dev_handle *dh;

  if ( luxeed_open(dev) ) {
    return -1;
  }

  dh = dev->u_dh;

  fprintf(stderr, "send_bytes(%d, %d)...", (int) ep, (int) size);
  {
    int i;
    for ( i = 0; i < size; ++ i ) {
      if ( i % 0x10 == 0 ) {
	fprintf(stderr, "\n");
      }
      fprintf(stderr, "%02x ", (int) bytes[i]);
    }
    fprintf(stderr, "\n\n");
  }

  {
    unsigned char *buf = bytes;
    int left = size;
    int blksize = 64;

    while ( left > 0 ) {
      RCALL(usb_bulk_write(dh, ep, buf, left, timeout));
      // RCALL(usb_interrupt_write(dh, ep, buf, blksize < left ? blksize : left, timeout));
      usleep(10000);
      if ( result < 0 ) break;
      buf += result;
      left -= result;
    }
  }
  if ( result >= 0 ) {
    result = 0;
  }
  

  /* Read result */
  if ( 0 ) {
    char buf[1024];
    int buf_size = sizeof(buf);
    RCALL(usb_bulk_read(dh, ep, buf, buf_size, timeout));
    if ( result < size ) {
      result = -1;
    }
  }

  return result;
}


int luxeed_init(luxeed_device *dev)
{
  int result = -1;

  do {
    {
      static unsigned char msg[] = {
	/* 0000: */ 0x02, 0x02, 0x01, 0x80, 0x00, 0x01, 0x01, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 
	/* 0010: */ 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* 0020: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* 0030: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	/*     : */ 0x00,
	/* 0040: */       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	/* 0050: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* 0060: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* 0070: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	/*     : */ 0x00,
	/* 0080: */       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	/* 0090: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* 00a0: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* 00b0: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	/*     : */ 0x00,
	/* 00c0: */       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	/* 00d0: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* 00e0: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* 00f0: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	/*     : */ 0x00,
	/* 0100: */       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	/* 0110: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* 0120: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* 0130: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	/*     : */ 0x00,
	/* 0140: */       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb0, 
	/* 0150: */ 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* 0160: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	/* 0170: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	/*     : */ 0x00,
      };
      RCALL(luxeed_send(dev, LUXEED_USB_ENDPOINT_DATA, msg + 1, sizeof(msg) - 1));
      usleep(1000000);
    }
  } while ( 0 );

  return result;
}


int luxeed_ffff(luxeed_device *dev)
{
  int result = -1;

  unsigned char msg[] = {
    /* 0000: */ 0x02, 0x02, 0x01, 0x80, 0x00, 0x00, 0x16, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 
    /* 0010: */ 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0020: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0030: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    /*     : */ 0xff,
    /* 0040: */       0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0050: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0060: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0070: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /*     : */ 0xff,
    /* 0080: */       0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0090: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 00a0: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 00b0: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /*     : */ 0xff,
    /* 00c0: */       0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 00d0: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 00e0: */ 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
    /* 00f0: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
    /*     : */ 0x00,
    /* 0100: */       0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0110: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
    /* 0120: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0130: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /*     : */ 0x00,
    /* 0140: */       0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe6,
    /* 0150: */ 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0160: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0170: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /*     : */ 0x00,
  };
#if 1
  static int call = 0;
  if ( call ++ % 2 ) {
  int i;
  for ( i = 0; i < 16; ++ i ) {
    int j = (rand() % 64) * 3;
    int c = rand() & 0xff;
    msg[0x39 + j + 0] = c;
    msg[0x39 + j + 1] = c;
    msg[0x39 + j + 2] = c;
  }
  }
#endif
  RCALL(luxeed_send(dev, LUXEED_USB_ENDPOINT_DATA, msg + 1, sizeof(msg) - 1));
  usleep(500000);

  return result;
}



int luxeed_update(luxeed_device *dev)
{
  int result = -1;

  do {
    /* Send data */
    dev->msg[0] = 0x02;
    memcpy(dev->msg + 1, dev->key_data, 64);
    dev->msg_size = 65;

    result = luxeed_send(dev, LUXEED_USB_ENDPOINT_DATA, dev->msg + 1, dev->msg_size - 1);
    if ( result ) break;

#if 0
    result = luxeed_send(dev, LUXEED_USB_ENDPOINT_DATA, dev->msg + 1, dev->msg_size - 1);
    if ( result ) break;

    result = luxeed_send(dev, LUXEED_USB_ENDPOINT_DATA, dev->msg + 1, dev->msg_size - 1);
    if ( result ) break;
#endif


#if 0
    /* Send control */
    {
      static unsigned char ep_2[] = { 0x01, 0x079 };
      
      result = luxeed_send(dev, LUXEED_USB_ENDPOINT_CONTROL, ep_2, sizeof(ep_2));
      if ( result ) break;
    }
#endif

  } while ( 0 );

  return result;
}



int main (int argc, char **argv)
{
  luxeed_device *dev;

  dev = luxeed_find_device(0, 0);

  //If the keyboard wasn't found the function will have returned NULL
  if ( ! dev ) {
    fprintf(stderr, "luxeed keyboard not found\n");
    return 1;
  }

  {
    int msg_id = 0;
    int result = 0;

    while ( 1 ) {
      dev->key_data[rand() % 64] = (0xff - msg_id) & 0xff;

      result = luxeed_ffff(dev);
      if ( result ) break;

      usleep(1000000);
      msg_id ++;
    }
  }

  luxeed_close(dev);
  
  return 0;
}


/* EOF */

