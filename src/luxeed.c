
/*
sudo apt-get install libusb-dev
*/

#include <stdio.h>
#include <stdlib.h> /* memset(), memcpy() */
#include <string.h>
#include <assert.h>
#include "luxeed.h"


static int luxeed_dev_id = 0;

static int usb_debug_level = 9;


#if 1
#define RCALL(X) do { result = X; if ( result != 0 && dev->debug ) { fprintf(stderr, "  %s => %d\n", #X, (int) result); } } while ( 0 )
#else
#define RCALL(X) result = X
#endif


/* Parsed from ep01.txt as initialization, minues the leading 0x02.
   Chunks are sent 65 bytes long.
   Checksum appears at 0x14f.
*/
static unsigned char msg_00[] = {
  /* 0000: */       0x02, 0x01, 0x80, 0x00, 0x01, 0x01, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 
  /* 0010: */ 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  /* 0020: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  /* 0030: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  /*     : */ 0x00,
  /* 0040: */       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  /* 0050: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  /* 0060: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  /* 0070: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  /*     : */ 0x00,
  /* 0080: */       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  /* 0090: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  /* 00a0: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  /* 00b0: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  /*     : */ 0x00,
  /* 00c0: */       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  /* 00d0: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  /* 00e0: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  /* 00f0: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  /*     : */ 0x00,
  /* 0100: */       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  /* 0110: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  /* 0120: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  /* 0130: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  /*     : */ 0x00,
  /* 0140: */       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb0, 
  /* 0150: */ 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  /* 0160: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  /* 0170: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  /*     : */ 0x00,
};
static int msg_size = sizeof(msg_00);


static unsigned char msg_ff[] = {
    /*             f     0     1     2     3     4     5     6     7     8     9     a     b     c     d     e  */
    /*                                                aa    bb                                                  */
    /* 0000: */       0x02, 0x01, 0x80, 0x00, 0x00, 0x16, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 
    /* 0010: */ 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0020: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0030: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    /*     : */ 0xff,

    /* 0040: */       0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0050: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0060: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0070: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /*     : */ 0xff,

    /* 0080: */       0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0090: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 00a0: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 00b0: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /*     : */ 0xff,

    /* 00c0: */       0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 00d0: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 00e0: */ 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
    /* 00f0: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
    /*     : */ 0x00,

    /* 0100: */       0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0110: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
    /* 0120: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0130: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /*     : */ 0x00,

    /*                                                                                                      cc,
		  dd											        */
    /* 0140: */       0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe6,
    /* 0150: */ 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0160: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0170: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /*     : */ 0x00,
  };


static unsigned char msg_xx[] = {
    /*             f     0     1     2     3     4     5     6     7     8     9     a     b     c     d     e  */
    /*                                                aa    bb                                                  */
    /* 0000: */       0x02, 0x01, 0x80, 0x00, 0x00, 0x16, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 
    /* 0010: */ 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0020: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0030: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    /*     : */ 0xff,

    /* 0040: */       0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0050: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0060: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0070: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /*     : */ 0xff,

    /* 0080: */       0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0090: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 00a0: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 00b0: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /*     : */ 0xff,

    /* 00c0: */       0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 00d0: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 00e0: */ 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
    /* 00f0: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
    /*     : */ 0x00,

    /* 0100: */       0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    /* 0110: */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
    /* 0120: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0130: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /*     : */ 0x00,

    /*                                                                                                      cc,
		  dd											        */
    /* 0140: */       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe6,
    /* 0150: */ 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0160: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 0170: */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /*     : */ 0x00,
  };


luxeed_device *luxeed_find_device(uint16_t vendor, uint16_t product)
{
  struct usb_bus *bus;
  struct usb_device *dev;
  struct usb_bus *busses;

  if ( ! vendor ) {
    vendor  = LUXEED_USB_VENDOR;
  }
  if ( ! product ) {
    product = LUXEED_USB_PRODUCT;
  }

  usb_init();
  usb_find_busses();
  usb_find_devices();
  busses = usb_get_busses();

  usb_set_debug(usb_debug_level);
  
  for ( bus = busses; bus; bus = bus->next ) {
    for ( dev = bus->devices; dev; dev = dev->next ) {
      if ( (dev->descriptor.idVendor == vendor) && (dev->descriptor.idProduct == product) ) {
	luxeed_device *luxeed = malloc(sizeof(*luxeed));

	memset(luxeed, 0, sizeof(*luxeed));
	luxeed->id = luxeed_dev_id ++;

	luxeed->u_bus = bus;
	luxeed->u_dev = dev;

	luxeed->msg_size = msg_size;
	luxeed->msg_len = msg_size;
	luxeed->msg = malloc(sizeof(luxeed->msg[0]) * luxeed->msg_size);
	memset(luxeed->msg, 0, sizeof(luxeed->msg[0]) * luxeed->msg_size);

	if ( 0 ) {
	  fprintf(stderr, "  bus %s 0x%x\n", (char*) bus->dirname, (int) bus->location);
	  fprintf(stderr, "  dev %s 0x%x\n", (char*) dev->filename, (int) dev->devnum);
	}

        return luxeed;
      }
    }
  }

  return NULL;
}


int luxeed_open(luxeed_device *dev)
{
  int result = -1;

  if ( dev->u_dh ) {
    return 0;
  }

  do {
    dev->u_dh = usb_open(dev->u_dev);
    if ( ! dev->u_dh ) {
      return -1;
    }
    
    RCALL(usb_reset(dev->u_dh));
    // RCALL(usb_resetep(dev->u_dh, LUXEED_USB_ENDPOINT_DATA));
    
    // RCALL(usb_detach_kernel_driver_np(dev->u_dh, LUXEED_USB_INTERFACE));
    // RCALL(usb_detach_kernel_driver_np(dev->u_dh, 0));
    RCALL(usb_detach_kernel_driver_np(dev->u_dh, 1));
    RCALL(usb_detach_kernel_driver_np(dev->u_dh, 2));
    
    // RCALL(usb_claim_interface(dev->u_dh, LUXEED_USB_INTERFACE));
    // RCALL(usb_claim_interface(dev->u_dh, 0));
    RCALL(usb_claim_interface(dev->u_dh, 1));
    RCALL(usb_claim_interface(dev->u_dh, 2));
    usleep(100000);

    /* Initialize all LEDS */
    luxeed_init(dev);

    result = 0;

  } while ( 0 );

  return result;
}


int luxeed_close(luxeed_device *dev)
{
  int result = 0;

  do {
    if ( dev->u_dh ) {
      RCALL(usb_release_interface(dev->u_dh, 1));
      RCALL(usb_release_interface(dev->u_dh, 2));

      RCALL(usb_close(dev->u_dh));
      if ( result ) break;

      dev->u_dh = 0;
    }
  } while ( 0 );

  return result;
}


int luxeed_destroy(luxeed_device *dev)
{
  luxeed_close(dev);
  free(dev->msg);
  free(dev);

  return 0;
}

static int dump_buf(unsigned char *bytes, int size)
{
  int i;

  fprintf(stderr, "\n      ");
  for ( i = 0; i < 0x10; ++ i ) {
    fprintf(stderr, "%2x ", (int) i);
  }
  for ( i = 0; i < size; ++ i ) {
    if ( i % 0x10 == 0 ) {
      fprintf(stderr, "\n%04x: ", (int) i);
    }
    fprintf(stderr, "%02x ", (int) bytes[i]);
  }
  fprintf(stderr, "\n\n");

  return 0;
}



int luxeed_send(luxeed_device *dev, int ep, unsigned char *bytes, int size)
{
  int result = -1;
  int timeout = 1000;

  usb_dev_handle *dh;

  if ( luxeed_open(dev) ) {
    return -1;
  }

  dh = dev->u_dh;

  luxeed_msg_checksum(dev, bytes, size);

  if ( dev->debug ) {
    fprintf(stderr, "send_bytes(%d, %d)...", (int) ep, (int) size);
    dump_buf(bytes, size);
  }


  {
    unsigned char *buf = bytes;
    int left = size;
    int blksize = 64;

    while ( left > 0 ) {
      unsigned char xbuf[1 + blksize];

      xbuf[0] = 0x02;
      memcpy(xbuf + 1, buf, blksize);

      int wsize = blksize < left ? blksize : left;
      wsize += 1;

      if ( dev->debug > 1 ) {
	dump_buf(xbuf, wsize);
      }

      RCALL(usb_interrupt_write(dh, ep, xbuf, wsize, timeout));
      // usleep(10000);

      if ( result != wsize ) {
	result = -1;
	break;
      }
      buf += blksize;
      left -= blksize;
    }
  }
  if ( result >= 0 ) {
    result = 0;
  }
  

  /* Read result */
  if ( 0 ) {
    char buf[1024];
    int buf_size = sizeof(buf);
    RCALL(usb_bulk_read(dh, ep, buf, buf_size, timeout));
    if ( result < size ) {
      result = -1;
    }
  }

  if ( 0 ) {
    RCALL(usb_clear_halt(dh, ep));
  }

  return result;
}




int luxeed_msg_checksum(luxeed_device *dev, unsigned char *buf, int size)
{
  int sum = 0;
  int i;
  int sum_save;
  int chksum_i = 0x14e; // 0x154 in total msg output.

  // return 0;

  if ( dev->debug ) {
    if ( buf == msg_ff || buf == msg_00 ) {
      dump_buf(buf, size);
    }
  }
  
  sum_save = buf[chksum_i];
  buf[chksum_i] = 0;

  for ( i = 0; i < size; ++ i ) {
    sum += buf[i];
  }
  sum -= 5;
  sum &= 0xff;

  buf[chksum_i] = sum;

  if ( buf == msg_ff || buf == msg_00 ) {
    if ( sum != sum_save ) {
      dump_buf(buf, size);
      fprintf(stderr, "%p sum %02x, expected %02x\n", (void*) buf, (int) sum, (int) sum_save);
      assert(sum == sum_save);
    }
  } else {
    buf[chksum_i - 1] = 0;
  }

  return sum;
}


int luxeed_init(luxeed_device *dev)
{
  int result = -1;

  do {
    int slp = 50000;
    int i;
    int n = 5;

    usleep(slp);
    for ( i = 0; i < n; ++ i ) {

      RCALL(luxeed_send(dev, LUXEED_USB_ENDPOINT_DATA, msg_00, sizeof(msg_00)));
      if ( result ) return result;
      usleep(slp);
      
      RCALL(luxeed_send(dev, LUXEED_USB_ENDPOINT_DATA, msg_ff, sizeof(msg_ff)));
      if ( result ) return result;
      usleep(slp);
    }

  } while ( 0 );

  return result;
}


unsigned char *luxeed_pixel(luxeed_device *dev, int key)
{
  if ( key < 0 || key >= LUXEED_NUM_OF_KEYS ) {
    return 0;
  }
  return &dev->key_data[key * 3];
}


int luxeed_update(luxeed_device *dev)
{
  int result = 0;

  do {
    /* Send data */
    assert(dev->msg_size == sizeof(msg_xx));

    /* Start with basic msg. */
    memcpy(dev->msg, msg_xx, dev->msg_size);

    /* Copy key pixel data into place. */
    memcpy(dev->msg + 0x37, dev->key_data, sizeof(dev->key_data));

    /* Compute checksum and send in chunks. */
    result = luxeed_send(dev, LUXEED_USB_ENDPOINT_DATA, dev->msg, dev->msg_size);
    if ( result ) break;

    if ( 0 ) {
      unsigned char msg_ctrl[] = { 0x01, 0x79 };
      result = luxeed_send(dev, LUXEED_USB_ENDPOINT_CONTROL, msg_ctrl, sizeof(msg_ctrl));
    }
    if ( result ) break;

  } while ( 0 );

  return result;
}


static struct {
  int offset;
  const char *map;
} _key_maps[] = {
  { 0 , "`123456789" },
  { 0 , "~!@#$%^&*(" }, /* SHIFT */
  { 10, "0-=\01BKSP\01TAB qwert" },
  { 10, ")_+\01BKSP\01TAB QWERT" },  /* SHIFT */
  { 20, "yuiop[]\\\01CPLKa" },
  { 20, "YUIOP{}|\01CPLKA" },  /* SHIFT */
  { 30, "sdfghjkl;" },
  { 30, "SDFGHJKL:" },  /* SHIFT */
  { 40, "\01ENTR\01LSFzxcvbnm," },
  { 40, "\01ENTR\01LSFZXCVBNM<" },  /* SHIFT */
  { 50, "./\01RSFT\01LCTR\01RWIN\01LALT\02RALT\01LWIN\01MENU\01RCTR" },
  { 50, ">?" }, /* SHIFT */
  { -1, 0 }
};

static luxeed_key _keys[LUXEED_NUM_OF_KEYS];

int luxeed_init_keys()
{
  int i;
  const char *s;

  for ( i = 0; s = _key_maps[i].map; ++ i ) {
    int k = _key_maps[i].offset;

    while ( *s ) {
      luxeed_key *key;
      char name[5];
      int j;

      memset(name, 0, sizeof(name));

      /* "\01TAB " or "\01LSFT" */
      if ( *s == '\01' ) {
	++ s;
	memcpy(name, s, 4);
	if ( name[3] == ' ' ) 
	  name[3] = '\0';
	s += 4;
      } else {
	name[0] = *(s ++);
      }

      key = &_keys[k];
      key->id = k;
      {
	int j = 0;
	while ( key->name[j] ) {
	  ++ j;
	}
	key->name[j] = strdup(name);
      }

      k ++;
    }
  }

  return 0;
}




/* EOF */

